<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#282828">
    <meta name="description" content="Your fully featured EDC - Every Day Calculator">
    <title>pyco</title>
    <link rel="icon" type="image/x-icon" href="pyco.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            background-color: #282828;
            font-family: "Courier New", Consolas, monospace;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height - adjusts for virtual keyboard */
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Main terminal window */
        .terminal-window {
            display: flex;
            flex-direction: column;
            flex: 1;
            border: 5px solid #8a8375;
            border-radius: 3px;
            overflow: hidden;
            box-shadow: 
                0 0 0 2px #716c5f,
                0 0 0 4px #5d5848,
                0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* Menu bar */
        .menu-bar {
            background-color: #323232;
            color: #dcdcdc;
            border-bottom: 1px solid #8a8375;
            padding: 0;
            display: flex;
            font-size: 14px;
            font-weight: bold;
        }

        .menu-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background-color: #8a8375;
            color: #ffffff;
        }

        /* Terminal content area with CRT border layers */
        .terminal-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #716c5f;
            padding: 10px;
            min-height: 0;
            overflow: hidden;
        }

        /* Multi-layer CRT border effect */
        .crt-border-outer {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1b301b;
            padding: 2px;
            border-radius: 2px;
            min-height: 0;
            overflow: hidden;
        }

        .crt-border-mid1 {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1e3320;
            padding: 2px;
            border-radius: 2px;
            min-height: 0;
            overflow: hidden;
        }

        .crt-border-mid2 {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #213825;
            padding: 2px;
            border-radius: 2px;
            min-height: 0;
            overflow: hidden;
        }

        .crt-border-mid3 {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #243d2a;
            padding: 2px;
            border-radius: 2px;
            min-height: 0;
            overflow: hidden;
        }

        .crt-border-mid4 {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #27422f;
            padding: 2px;
            border-radius: 2px;
            min-height: 0;
            overflow: hidden;
        }

        .crt-border-inner {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #2a4734;
            padding: 2px;
            border-radius: 2px;
            min-height: 0;
            overflow: hidden;
        }

        .repl-container .pyrepl {
            flex: 1;
            display: flex !important;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }

        /* Make xterm terminal fill the container */
        .pyrepl > div {
            flex: 1 !important;
            height: 100% !important;
            min-height: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .xterm {
            flex: 1 !important;
            height: 100% !important;
            min-height: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
        }

        .xterm-viewport {
            height: 100% !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .xterm-screen {
            height: 100% !important;
        }

        .xterm-helper-textarea {
            position: absolute !important;
        }

        .repl-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        /* Text selection overlay - shown on long press */
        .text-selection-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a1f0a;
            z-index: 100;
            overflow: hidden;
            -webkit-user-select: text;
            user-select: text;
            touch-action: auto;
            -webkit-touch-callout: default;
        }

        .text-selection-overlay .text-content {
            color: #33cc33;
            white-space: pre;
            margin: 0;
            padding: 0;
            -webkit-user-select: text;
            user-select: text;
            font-weight: normal;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: auto;
            -webkit-touch-callout: default;
        }

        .text-selection-overlay .text-content * {
            -webkit-user-select: text !important;
            user-select: text !important;
            touch-action: auto !important;
            -webkit-touch-callout: default !important;
        }

        /* Style cloned xterm rows in overlay */
        .text-selection-overlay .xterm-rows {
            position: static !important;
            transform: none !important;
            top: auto !important;
            left: auto !important;
        }
        
        .text-selection-overlay .xterm-rows > div {
            position: static !important;
            top: auto !important;
            transform: none !important;
        }
        
        .text-selection-overlay .xterm-rows > div > span {
            letter-spacing: 0 !important;
        }

        .text-selection-overlay.active {
            display: block;
        }

        /* CRT scanlines overlay */
        .repl-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15) 0px,
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 10;
        }

        /* Stronger scanlines on mobile */
        @media (max-width: 768px) {
            .repl-container::before {
                background: repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.25) 0px,
                    rgba(0, 0, 0, 0.25) 1px,
                    transparent 1px,
                    transparent 3px
                );
            }
        }

        /* CRT vignette/edge shading */
        .repl-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(
                ellipse at center,
                transparent 60%,
                rgba(0, 0, 0, 0.3) 100%
            );
            pointer-events: none;
            z-index: 11;
        }

        /* Status bar */
        .status-bar {
            background-color: #8a8375;
            color: #ffffff;
            padding: 8px 16px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            border-top: 1px solid #8a8375;
        }

        /* Modal styles for help/about */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: #323232;
            border: 3px solid #8a8375;
            border-radius: 5px;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            color: #dcdcdc;
            padding: 20px;
        }

        .modal h2 {
            color: #00ff00;
            margin-bottom: 15px;
            font-family: "Courier New", monospace;
        }

        .modal p, .modal li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .modal ul {
            margin-left: 20px;
        }

        .modal-close {
            background-color: #8a8375;
            color: white;
            border: none;
            padding: 8px 20px;
            cursor: pointer;
            font-family: "Courier New", monospace;
            font-weight: bold;
            margin-top: 15px;
        }

        .modal-close:hover {
            background-color: #9a9385;
        }

        .keyboard-shortcut {
            background-color: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "Courier New", monospace;
        }

        /* Retro keyboard buttons */
        .keyboard-bar {
            display: flex;
            justify-content: stretch;
            gap: 6px;
            padding: 12px 16px;
            background: linear-gradient(to bottom, #4a4a4a 0%, #3a3a3a 50%, #2a2a2a 100%);
            border-top: 2px solid #5a5a5a;
            flex-wrap: nowrap;
            touch-action: none; /* Prevent page scroll when touching buttons */
        }

        .key-btn {
            font-family: "Courier New", Consolas, monospace;
            font-size: 11px;
            font-weight: bold;
            color: #1a1a1a;
            background: linear-gradient(to bottom, #d4d4d4 0%, #b8b8b8 20%, #a0a0a0 80%, #888888 100%);
            border: none;
            border-radius: 4px;
            padding: 10px 0;
            cursor: pointer;
            box-shadow: 
                0 4px 0 #555555,
                0 5px 3px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.05s ease;
            user-select: none;
            flex: 1 1 0;
            text-align: center;
            white-space: nowrap;
        }

        .key-btn:hover {
            background: linear-gradient(to bottom, #e0e0e0 0%, #c8c8c8 20%, #b0b0b0 80%, #989898 100%);
        }

        .key-btn:active {
            background: linear-gradient(to bottom, #a0a0a0 0%, #909090 20%, #808080 80%, #707070 100%);
            box-shadow: 
                0 1px 0 #555555,
                0 2px 2px rgba(0, 0, 0, 0.3),
                inset 0 1px 2px rgba(0, 0, 0, 0.2);
            transform: translateY(3px);
        }

        /* Arrow key cluster styling */
        .key-arrows {
            display: flex;
            gap: 4px;
            margin-left: 6px;
            padding-left: 10px;
            border-left: 2px solid #555555;
            flex: 4 1 0;
        }

        .key-btn.arrow {
            flex: 1 1 0;
            padding: 10px 0;
            font-size: 14px;
        }

        .key-btn.numpad {
            flex: 0.8 1 0;
            padding: 10px 0;
            font-size: 16px;
        }

        /* Expanded keyboard overlay - sized to fit content */
        .expanded-keyboard-overlay {
            display: none;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 760px;
            z-index: 500;
            background: linear-gradient(to bottom, #4a4a4a 0%, #3a3a3a 50%, #2a2a2a 100%);
            border-top: 3px solid #5a5a5a;
            padding: 8px 16px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
            touch-action: none; /* Prevent page scroll when touching buttons */
        }

        .expanded-keyboard-overlay.active {
            display: block;
        }

        /* When expanded keyboard is open, add bottom padding to container */
        body.keyboard-open .container {
            padding-bottom: var(--expanded-keyboard-height, 250px);
        }

        .expanded-keyboard-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            max-width: 100%;
            margin: 0 auto;
            width: 100%;
        }

        .expanded-keyboard-grid .key-btn {
            width: 100%;
            min-width: unset;
            padding: 10px 8px;
            font-size: 16px;
        }

        .expanded-keyboard-grid .key-btn.span-2 {
            grid-column: span 2;
        }

        .expanded-keyboard-grid .key-btn.span-4 {
            grid-column: span 4;
        }

        /* Secondary buttons (non-numeric, non-enter) - slightly darker */
        .key-btn.secondary {
            background: linear-gradient(to bottom, #b8b8b8 0%, #9c9c9c 20%, #848484 80%, #6c6c6c 100%);
        }

        .key-btn.secondary:hover {
            background: linear-gradient(to bottom, #c8c8c8 0%, #acacac 20%, #949494 80%, #7c7c7c 100%);
        }

        .key-btn.secondary:active {
            background: linear-gradient(to bottom, #888888 0%, #787878 20%, #686868 80%, #585858 100%);
        }

        /* Function browser modal */
        .function-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-sizing: border-box;
        }

        .function-modal-overlay.active {
            display: flex;
        }

        .function-modal {
            background-color: #2a2a2a;
            border: 3px solid #8a8375;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .function-modal-header {
            padding: 12px 16px;
            background: linear-gradient(to bottom, #4a4a4a 0%, #3a3a3a 100%);
            border-bottom: 2px solid #5a5a5a;
        }

        .function-modal-header h3 {
            color: #4ec94e;
            margin: 0 0 10px 0;
            font-family: "Courier New", monospace;
        }

        .function-search-input {
            width: 100%;
            padding: 10px 12px;
            font-family: "Courier New", Consolas, monospace;
            font-size: 14px;
            background: #1e1e1e;
            border: 2px solid #555;
            border-radius: 4px;
            color: #4ec94e;
            outline: none;
        }

        .function-search-input:focus {
            border-color: #4ec94e;
        }

        .function-search-input::placeholder {
            color: #666;
        }

        .function-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .function-item {
            padding: 10px 12px;
            font-family: "Courier New", Consolas, monospace;
            font-size: 13px;
            color: #dcdcdc;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            transition: background-color 0.15s;
        }

        .function-item:hover {
            background-color: #3a3a3a;
            color: #4ec94e;
        }

        .function-item-name {
            color: #dcdcaa;
        }

        .function-item-desc {
            color: #888;
            font-size: 11px;
            margin-top: 2px;
        }

        .function-modal-footer {
            padding: 12px 16px;
            background: #323232;
            border-top: 1px solid #555;
            text-align: right;
        }

        .function-modal-close {
            background: linear-gradient(to bottom, #d4d4d4 0%, #a0a0a0 100%);
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-family: "Courier New", monospace;
            font-weight: bold;
            color: #1a1a1a;
            cursor: pointer;
            box-shadow: 0 2px 0 #555;
        }

        .function-modal-close:hover {
            background: linear-gradient(to bottom, #e0e0e0 0%, #b0b0b0 100%);
        }

        .function-loading {
            text-align: center;
            padding: 40px;
            color: #888;
            font-family: "Courier New", monospace;
        }

        /* History item styles */
        .history-item {
            display: block;
            padding: 8px 12px;
        }

        .history-item.ans-row {
            background-color: #2a3a2a;
            border-bottom: 2px solid #4a5a4a;
            margin-bottom: 4px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .history-item.ans-row .history-var {
            color: #4ec94e;
        }

        /* History section headers and layout */
        .history-section {
            margin-bottom: 8px;
        }

        .history-section-header {
            font-family: "Courier New", monospace;
            font-size: 11px;
            font-weight: bold;
            color: #888;
            text-transform: uppercase;
            padding: 8px 12px 4px 12px;
            background-color: #252525;
            border-bottom: 1px solid #3a3a3a;
        }

        /* Saved variables row (compact buttons for ans, var1-var9) */
        .saved-vars-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 12px;
            background-color: #2a3a2a;
        }

        .saved-var-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 10px;
            background: linear-gradient(to bottom, #3a4a3a 0%, #2a3a2a 100%);
            border: 1px solid #4a5a4a;
            border-radius: 4px;
            cursor: pointer;
            min-width: 50px;
        }

        .saved-var-btn:hover {
            background: linear-gradient(to bottom, #4a5a4a 0%, #3a4a3a 100%);
            border-color: #4ec94e;
        }

        .saved-var-name {
            font-family: "Courier New", monospace;
            font-size: 14px;
            font-weight: bold;
            color: #4ec94e;
        }

        .saved-var-value {
            font-family: "Courier New", monospace;
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }

        .history-line {
            display: flex;
            gap: 8px;
            align-items: baseline;
        }

        .history-var {
            color: #569cd6;
            font-family: "Courier New", monospace;
            font-weight: bold;
            min-width: 35px;
        }

        .history-expression {
            color: #dcdcaa;
            font-family: "Courier New", monospace;
            white-space: pre-wrap;
            word-break: break-all;
            flex: 1;
        }

        .history-result {
            color: #4ec94e;
            font-family: "Courier New", monospace;
            padding-left: 43px;
            margin-top: 2px;
        }

        /* Store modal grid */
        .store-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
        }

        .store-modal-value {
            font-family: "Courier New", monospace;
            font-size: 14px;
            color: #888;
            margin-top: 6px;
            word-break: break-all;
        }

        .store-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: linear-gradient(to bottom, #3a3a3a 0%, #2a2a2a 100%);
            border: 2px solid #555;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .store-btn:hover {
            background: linear-gradient(to bottom, #4a4a4a 0%, #3a3a3a 100%);
            border-color: #4ec94e;
        }

        .store-btn:active {
            background: linear-gradient(to bottom, #2a2a2a 0%, #1a1a1a 100%);
        }

        .store-btn-var {
            font-family: "Courier New", monospace;
            font-size: 20px;
            font-weight: bold;
            color: #4ec94e;
        }

        .store-btn-value {
            font-family: "Courier New", monospace;
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Responsive styles for mobile */
        @media screen and (max-width: 600px) {
            .container {
                padding: 5px;
                max-width: 100%;
            }

            .terminal-window {
                border-width: 3px;
                box-shadow: 
                    0 0 0 1px #716c5f,
                    0 0 0 2px #5d5848,
                    0 0 10px rgba(0, 0, 0, 0.5);
            }

            .terminal-content {
                padding: 5px;
            }

            .crt-border-outer,
            .crt-border-mid1,
            .crt-border-mid2,
            .crt-border-mid3,
            .crt-border-mid4,
            .crt-border-inner {
                padding: 2px;
            }

            .menu-bar {
                font-size: 12px;
            }

            .menu-item {
                padding: 6px 10px;
            }

            .status-bar {
                padding: 6px 12px;
                font-size: 14px;
            }

            .keyboard-bar {
                gap: 4px;
                padding: 8px 8px;
            }

            .key-btn {
                font-size: 10px;
                padding: 8px 0;
                box-shadow: 
                    0 3px 0 #555555,
                    0 4px 2px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }

            .key-btn:active {
                transform: translateY(2px);
            }

            .key-arrows {
                margin-left: 4px;
                padding-left: 8px;
                gap: 4px;
            }

            .key-btn.arrow {
                padding: 8px 0;
                font-size: 12px;
            }

            .key-btn.numpad {
                padding: 8px 0;
                font-size: 14px;
            }

            .expanded-keyboard-overlay {
                width: calc(100% - 10px);
                padding: 8px 5px;
            }

            .expanded-keyboard-grid {
                gap: 6px;
            }

            .expanded-keyboard-grid .key-btn {
                padding: 6px 4px;
                font-size: 24px;
            }

            .function-modal {
                max-height: 60vh;
            }

            .function-item {
                padding: 8px 10px;
                font-size: 12px;
            }

            .modal {
                margin: 10px;
                max-width: calc(100% - 20px);
                padding: 15px;
            }

            .modal h2 {
                font-size: 18px;
            }
        }

        /* Extra small screens */
        @media screen and (max-width: 380px) {
            .keyboard-bar {
                gap: 3px;
                padding: 6px 4px;
            }

            .key-btn {
                font-size: 9px;
                padding: 7px 0;
            }

            .key-btn.arrow {
                padding: 7px 0;
                font-size: 11px;
            }

            .key-btn.numpad {
                padding: 7px 0;
                font-size: 13px;
            }

            .key-arrows {
                margin-left: 3px;
                padding-left: 6px;
                gap: 3px;
            }

            .expanded-keyboard-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 4px;
            }

            .expanded-keyboard-grid .key-btn {
                padding: 4px 2px;
                font-size: 21px;
            }

            .key-arrows {
                margin-left: 2px;
                padding-left: 6px;
            }
        }

        /* Ensure 42 columns fit on mobile by reducing font size */
        @media screen and (max-width: 600px) {
            .xterm {
                font-size: 11px !important;
            }
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="terminal-window">
            <!-- Menu Bar -->
            <div class="menu-bar">
                <div class="menu-item" onclick="window.open('https://github.com/LeeHolmes/pyco/blob/main/README.md', '_blank')">Help</div>
                <div class="menu-item" onclick="showAbout()">About</div>
                <div class="menu-item" id="devToolsMenuItem" style="display: none;" onclick="showDevTools()">DevTools</div>
            </div>

            <!-- Terminal Content with CRT Border Layers -->
            <div class="terminal-content">
                <div class="crt-border-outer">
                    <div class="crt-border-mid1">
                        <div class="crt-border-mid2">
                            <div class="crt-border-mid3">
                                <div class="crt-border-mid4">
                                    <div class="crt-border-inner">
                                        <div class="repl-container">
                                            <div class="pyrepl" 
                                                 data-theme="pyco-crt"
                                                 data-title="python"
                                                 data-header="false"
                                                 data-buttons="false"
                                                 data-src="https://raw.githubusercontent.com/LeeHolmes/pyco/main/pyco.py"
                                                 data-src-output="true"
                                                 data-startup-message="false">
                                            </div>
                                            <div class="text-selection-overlay" id="textSelectionOverlay">
                                                <div class="text-content"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">pyco</div>

            <!-- Keyboard Buttons -->
            <div class="keyboard-bar">
                <button class="key-btn" data-key="escape">ESC</button>
                <button class="key-btn wide" data-key="home">HOME</button>
                <button class="key-btn wide" data-key="end">END</button>
                <button class="key-btn" data-key="tab">TAB</button>
                <div class="key-arrows">
                    <button class="key-btn arrow" data-key="left">←</button>
                    <button class="key-btn arrow" data-key="up">↑</button>
                    <button class="key-btn arrow" data-key="down">↓</button>
                    <button class="key-btn arrow" data-key="right">→</button>
                </div>
                <button class="key-btn numpad" id="numpadToggle" title="Number pad">⠿</button>
            </div>
        </div>
    </div>

    <!-- Expanded Keyboard Overlay -->
    <div class="expanded-keyboard-overlay" id="expandedKeyboard">
        <div class="expanded-keyboard-grid">
            <!-- Row 1: C + Numbers -->
            <button class="key-btn secondary" data-key="ctrl-l">C</button>
            <button class="key-btn" data-char="7">7</button>
            <button class="key-btn" data-char="8">8</button>
            <button class="key-btn" data-char="9">9</button>
            <button class="key-btn secondary" data-char="/">÷</button>
            <!-- Row 2 -->
            <button class="key-btn secondary" data-key="backspace">⌫</button>
            <button class="key-btn" data-char="4">4</button>
            <button class="key-btn" data-char="5">5</button>
            <button class="key-btn" data-char="6">6</button>
            <button class="key-btn secondary" data-char="*">×</button>
            <!-- Row 3 -->
            <button class="key-btn secondary" data-char="(">(</button>
            <button class="key-btn" data-char="1">1</button>
            <button class="key-btn" data-char="2">2</button>
            <button class="key-btn" data-char="3">3</button>
            <button class="key-btn secondary" data-char="-">−</button>
            <!-- Row 4 -->
            <button class="key-btn secondary" data-char=")">)</button>
            <button class="key-btn secondary" data-char=".">.</button>
            <button class="key-btn" data-char="0">0</button>
            <button class="key-btn secondary" data-char="-">±</button>
            <button class="key-btn secondary" data-char="+">+</button>
            <!-- Row 5: f(x), STO, ANS, Enter -->
            <button class="key-btn secondary" id="functionBrowserBtn">f(x)</button>
            <button class="key-btn secondary" id="stoBtn">STO</button>
            <button class="key-btn secondary" id="rclBtn">VAR</button>
            <button class="key-btn span-2" data-key="enter">⏎ / =</button>
        </div>
    </div>

    <!-- Function Browser Modal -->
    <div class="function-modal-overlay" id="functionModal">
        <div class="function-modal">
            <div class="function-modal-header">
                <h3>Function Browser</h3>
                <input type="text" class="function-search-input" id="functionSearchInput" 
                       placeholder="Search functions..." autocomplete="off" autocorrect="off" 
                       autocapitalize="off" spellcheck="false">
            </div>
            <div class="function-list" id="functionList">
                <div class="function-loading">Loading functions...</div>
            </div>
            <div class="function-modal-footer">
                <button class="function-modal-close" id="functionModalClose">Close</button>
            </div>
        </div>
    </div>

    <!-- History Modal (reuses function-modal styles) -->
    <div class="function-modal-overlay" id="historyModal">
        <div class="function-modal">
            <div class="function-modal-header">
                <h3>Calculation History</h3>
            </div>
            <div id="historySavedSection"></div>
            <div id="historyAutomaticHeader" class="history-section-header" style="display: none;">Automatic</div>
            <div class="function-list" id="historyList">
                <div class="function-loading">No history yet</div>
            </div>
            <div class="function-modal-footer">
                <button class="function-modal-close" id="historyModalClose">Close</button>
            </div>
        </div>
    </div>

    <!-- Store Modal -->
    <div class="function-modal-overlay" id="storeModal">
        <div class="function-modal">
            <div class="function-modal-header">
                <h3 id="storeModalTitle">Store into:</h3>
                <div id="storeModalValue" class="store-modal-value"></div>
            </div>
            <div class="store-grid" id="storeGrid">
                <!-- Buttons for ans, var1-var8 will be generated dynamically -->
            </div>
            <div class="function-modal-footer">
                <button class="function-modal-close" id="storeModalClose">Cancel</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal-overlay" id="aboutModal">
        <div class="modal">
            <h2>Pyco - Happy Calculating!</h2>
            <p><strong>Your fully featured EDC - Every Day Calculator</strong></p>
            <p>
                Lee Holmes and Contributors<br>
                <a href="https://github.com/LeeHolmes/pycoterm" style="color: #00ff00;">https://github.com/LeeHolmes/pycoterm</a>
            </p>
            <p style="margin-top: 20px;">
                Browser-hosted console courtesy of pyrepl-web<br>
                <a href="https://github.com/savannahostrowski/pyrepl-web" style="color: #00ff00;">https://github.com/savannahostrowski/pyrepl-web</a>
            </p>
            <button class="modal-close" onclick="closeAbout()">Close</button>
        </div>
    </div>

    <!-- DevTools Modal -->
    <div class="modal-overlay" id="devToolsModal">
        <div class="modal" style="width: 90%; max-width: 800px; height: 70vh; display: flex; flex-direction: column;">
            <h2 style="flex-shrink: 0;">Console Output</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-shrink: 0;">
                <button class="modal-close" onclick="copyDevTools()">Copy All</button>
                <button class="modal-close" onclick="clearDevTools()">Clear</button>
                <button class="modal-close" onclick="closeDevTools()">Close</button>
            </div>
            <pre id="devToolsOutput" style="flex: 1; overflow: auto; background: #1e1e1e; padding: 10px; font-size: 12px; white-space: pre-wrap; word-break: break-all;"></pre>
        </div>
    </div>

    <!-- Register custom theme BEFORE loading pyrepl-web -->
    <script>
        window.pyreplThemes = {
            'pyco-crt': {
                // Terminal colors (xterm.js)
                background: '#182a18',
                foreground: '#4ec94e',
                cursor: '#4ec94e',
                cursorAccent: '#182a18',
                selectionBackground: '#008000',
                black: '#182a18',
                red: '#ce9178',
                green: '#6a9955',
                yellow: '#dcdcaa',
                blue: '#569cd6',
                magenta: '#c586c0',
                cyan: '#9cdcfe',
                white: '#d4d4d4',
                brightBlack: '#6a9955',
                brightRed: '#ce9178',
                brightGreen: '#4ec94e',
                brightYellow: '#b5cea8',
                brightBlue: '#569cd6',
                brightMagenta: '#c586c0',
                brightCyan: '#9cdcfe',
                brightWhite: '#ffffff',
                headerBackground: '#182a18',
                headerTitle: '#64c864',
                
                // Pygments syntax highlighting style (flat structure)
                pygmentsStyle: {
                    // Default text
                    'Token': '#4ec94e',
                    'Whitespace': '#4ec94e',
                    
                    // Comments
                    'Comment': '#6a9955',
                    'Comment.Preproc': '#6a9955',
                    'Comment.Single': '#6a9955',
                    'Comment.Multiline': '#6a9955',
                    
                    // Keywords
                    'Keyword': 'bold #569cd6',
                    'Keyword.Constant': '#569cd6',
                    'Keyword.Declaration': '#569cd6',
                    'Keyword.Namespace': '#569cd6',
                    'Keyword.Pseudo': '#569cd6',
                    'Keyword.Reserved': '#569cd6',
                    'Keyword.Type': '#569cd6',
                    
                    // Operators
                    'Operator': '#d4d4d4',
                    'Operator.Word': 'bold #569cd6',
                    'Punctuation': '#d4d4d4',
                    
                    // Names (variables, functions, classes)
                    'Name': '#9cdcfe',
                    'Name.Attribute': '#9cdcfe',
                    'Name.Builtin': '#dcdcaa',
                    'Name.Builtin.Pseudo': '#9cdcfe',
                    'Name.Class': '#dcdcaa',
                    'Name.Constant': '#9cdcfe',
                    'Name.Decorator': '#dcdcaa',
                    'Name.Entity': '#9cdcfe',
                    'Name.Exception': '#dcdcaa',
                    'Name.Function': '#dcdcaa',
                    'Name.Function.Magic': '#dcdcaa',
                    'Name.Property': '#9cdcfe',
                    'Name.Label': '#9cdcfe',
                    'Name.Namespace': '#9cdcfe',
                    'Name.Other': '#9cdcfe',
                    'Name.Tag': '#569cd6',
                    'Name.Variable': '#9cdcfe',
                    'Name.Variable.Class': '#9cdcfe',
                    'Name.Variable.Global': '#9cdcfe',
                    'Name.Variable.Instance': '#9cdcfe',
                    'Name.Variable.Magic': '#9cdcfe',
                    
                    // Strings
                    'String': '#ce9178',
                    'String.Affix': '#ce9178',
                    'String.Backtick': '#ce9178',
                    'String.Char': '#ce9178',
                    'String.Delimiter': '#ce9178',
                    'String.Doc': '#6a9955',
                    'String.Double': '#ce9178',
                    'String.Escape': '#d7ba7d',
                    'String.Heredoc': '#ce9178',
                    'String.Interpol': '#ce9178',
                    'String.Other': '#ce9178',
                    'String.Regex': '#d16969',
                    'String.Single': '#ce9178',
                    'String.Symbol': '#ce9178',
                    
                    // Numbers
                    'Number': '#b5cea8',
                    'Number.Bin': '#b5cea8',
                    'Number.Float': '#b5cea8',
                    'Number.Hex': '#b5cea8',
                    'Number.Integer': '#b5cea8',
                    'Number.Integer.Long': '#b5cea8',
                    'Number.Oct': '#b5cea8',
                    
                    // Literals
                    'Literal': '#ce9178',
                    'Literal.Date': '#ce9178',
                    
                    // Generic
                    'Generic': '#4ec94e',
                    'Generic.Deleted': '#f44747',
                    'Generic.Emph': 'italic',
                    'Generic.Error': '#f44747',
                    'Generic.Heading': 'bold #569cd6',
                    'Generic.Inserted': '#b5cea8',
                    'Generic.Output': '#4ec94e',
                    'Generic.Prompt': '#6a9955',
                    'Generic.Strong': 'bold',
                    'Generic.Subheading': '#569cd6',
                    'Generic.Traceback': '#f44747',
                    
                    // Errors
                    'Error': '#f44747'
                }
            }
        };

        // Set font size based on screen width to ensure 42+ columns
        (function() {
            const pyrepl = document.querySelector('.pyrepl');
            if (pyrepl) {
                // On narrow screens, use smaller font to fit 42 columns
                const fontSize = window.innerWidth <= 600 ? 11 : 14;
                pyrepl.dataset.fontSize = fontSize.toString();
            }
        })();
    </script>

    <!-- Load pyrepl-web locally -->
    <script src="pyrepl.js"></script>

    <script>
        // Prevent page scrolling globally - only allow in specific scrollable areas
        document.addEventListener('touchmove', (e) => {
            // Allow scrolling in modals and function list
            if (e.target.closest('.modal, .function-list, .text-selection-overlay')) {
                return;
            }
            // Prevent page scroll everywhere else
            e.preventDefault();
        }, { passive: false });
        
        // Check for debug mode
        const isDebugMode = new URLSearchParams(window.location.search).get('debug') === '1';
        
        // DevTools console capture - only in debug mode
        const devToolsLogs = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        if (isDebugMode) {
            // Show DevTools menu item
            document.addEventListener('DOMContentLoaded', () => {
                const menuItem = document.getElementById('devToolsMenuItem');
                if (menuItem) menuItem.style.display = '';
            });
            
            function addDevToolsEntry(type, args) {
                const timestamp = new Date().toLocaleTimeString();
                const message = Array.from(args).map(arg => {
                    if (typeof arg === 'object') {
                        try { return JSON.stringify(arg); } catch { return String(arg); }
                    }
                    return String(arg);
                }).join(' ');
                devToolsLogs.push(`[${timestamp}] [${type}] ${message}`);
                // Keep only last 500 entries
                if (devToolsLogs.length > 500) devToolsLogs.shift();
                // Update display if open
                const output = document.getElementById('devToolsOutput');
                if (output) {
                    output.textContent = devToolsLogs.join('\n');
                    output.scrollTop = output.scrollHeight;
                }
            }
            
            console.log = function(...args) {
                addDevToolsEntry('LOG', args);
                originalConsoleLog.apply(console, args);
            };
            console.error = function(...args) {
                addDevToolsEntry('ERROR', args);
                originalConsoleError.apply(console, args);
            };
            console.warn = function(...args) {
                addDevToolsEntry('WARN', args);
                originalConsoleWarn.apply(console, args);
            };
        }
        
        // DevTools modal functions
        function showDevTools() {
            document.getElementById('devToolsModal').classList.add('active');
            const output = document.getElementById('devToolsOutput');
            output.textContent = devToolsLogs.join('\n');
            output.scrollTop = output.scrollHeight;
        }
        
        function closeDevTools() {
            document.getElementById('devToolsModal').classList.remove('active');
        }
        
        function clearDevTools() {
            devToolsLogs.length = 0;
            document.getElementById('devToolsOutput').textContent = '';
        }
        
        function copyDevTools() {
            const text = devToolsLogs.join('\n');
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            // Create a temporary textarea and select its content
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '0';
            textarea.style.top = '0';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (e) {
                // Select the output so user can manually copy
                const output = document.getElementById('devToolsOutput');
                const range = document.createRange();
                range.selectNodeContents(output);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                alert('Text selected - use your browser\'s copy function');
            }
            document.body.removeChild(textarea);
        }

        // Modal functions
        function showAbout() {
            document.getElementById('aboutModal').classList.add('active');
        }

        function closeAbout() {
            document.getElementById('aboutModal').classList.remove('active');
        }

        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close expanded keyboard
                const expKb = document.getElementById('expandedKeyboard');
                if (expKb && expKb.classList.contains('active')) {
                    expKb.classList.remove('active');
                    return;
                }
                // Close function modal
                const funcModal = document.getElementById('functionModal');
                if (funcModal && funcModal.classList.contains('active')) {
                    funcModal.classList.remove('active');
                    return;
                }
                // Close store modal
                const stoModal = document.getElementById('storeModal');
                if (stoModal && stoModal.classList.contains('active')) {
                    stoModal.classList.remove('active');
                    return;
                }
                // Close history modal
                const histModal = document.getElementById('historyModal');
                if (histModal && histModal.classList.contains('active')) {
                    histModal.classList.remove('active');
                    return;
                }
                // Close other modals
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.classList.remove('active');
                });
            }
        });

        // Keyboard button emulation
        // These should match what a physical keyboard sends so both use the same code path
        const keySequences = {
            'escape': '\x1b',           // ESC - same as physical keyboard
            'home': '\x1b[H',           // Home
            'end': '\x1b[F',            // End
            'tab': '\t',                // Tab
            'left': '\x1b[D',           // Left arrow
            'right': '\x1b[C',          // Right arrow
            'up': '\x1b[A',             // Up arrow
            'down': '\x1b[B'            // Down arrow
        };

        // Wait for terminal to be ready, then attach button handlers
        function attachKeyboardButtons() {
            const pyreplContainer = document.querySelector('.pyrepl');
            
            const checkTerminal = setInterval(() => {
                if (pyreplContainer && pyreplContainer.pyreplConsole) {
                    clearInterval(checkTerminal);
                    
                    // Find the terminal's hidden textarea for refocusing
                    const termTextarea = pyreplContainer.querySelector('.xterm-helper-textarea');
                    
                    document.querySelectorAll('.key-btn').forEach(btn => {
                        // Prevent buttons from stealing focus (keeps virtual keyboard open)
                        btn.addEventListener('mousedown', (e) => e.preventDefault());
                        btn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            // Haptic feedback immediately on touch
                            if (navigator.vibrate) navigator.vibrate(20);
                        }, { passive: false });
                        
                        // Track if touch handled the event
                        let touchHandled = false;

                        // Handle key sending - use a shared function
                        const sendKey = () => {
                            const key = btn.dataset.key;
                            const sequence = keySequences[key];
                            if (sequence && pyreplContainer.pyreplConsole) {
                                // Send each character of the sequence to the terminal
                                for (const char of sequence) {
                                    pyreplContainer.pyreplConsole.push_char(char.charCodeAt(0));
                                }
                            }
                            // Refocus terminal to keep keyboard open (only if large keyboard is closed)
                            if (termTextarea && !document.body.classList.contains('keyboard-open')) {
                                termTextarea.focus();
                            }
                        };
                        
                        // On touch devices, handle touchend to send keys before focus can shift
                        btn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            touchHandled = true;
                            sendKey();
                            // Reset flag after a short delay (click fires ~300ms after touchend)
                            setTimeout(() => { touchHandled = false; }, 400);
                        }, { passive: false });
                        
                        // For mouse/desktop, use click
                        btn.addEventListener('click', (e) => {
                            // Skip if touchend already handled this
                            if (touchHandled) return;
                            e.preventDefault();
                            sendKey();
                        });
                    });
                }
            }, 100);
        }

        attachKeyboardButtons();

        // Touch scrolling for terminal - use xterm's scrollLines API with momentum
        (function setupTerminalTouchScroll() {
            const replContainer = document.querySelector('.repl-container');
            const pyreplContainer = document.querySelector('.pyrepl');
            const textOverlay = document.getElementById('textSelectionOverlay');
            const textContent = textOverlay?.querySelector('.text-content');
            if (!replContainer || !pyreplContainer) return;
            
            let touchStartY = 0;
            let touchStartX = 0;
            let lastTouchY = 0;
            let lastTouchTime = 0;
            let touchStartTime = 0;
            let isTouching = false;
            let isScrolling = false; // true once we've determined this is a scroll gesture
            let accumulatedDelta = 0;
            let velocity = 0;
            let momentumFrame = null;
            let longPressTimer = null;
            
            const SCROLL_THRESHOLD = 10; // pixels before we decide it's a scroll
            const LONG_PRESS_TIME = 500; // ms before we show text selection overlay
            
            function showTextOverlay(term) {
                if (!textOverlay || !textContent) return;
                
                // Get the styled content from xterm-rows
                const xtermRows = document.querySelector('.pyrepl .xterm-rows');
                if (!xtermRows) return;
                
                // Get the exact position of xterm-rows relative to repl-container
                const containerRect = replContainer.getBoundingClientRect();
                const rowsRect = xtermRows.getBoundingClientRect();
                const offsetTop = rowsRect.top - containerRect.top;
                const offsetLeft = rowsRect.left - containerRect.left;
                
                // Get xterm font settings from the terminal options
                const options = term.options;
                const dims = term.dimensions || term._core?._renderService?.dimensions;
                const cellHeight = dims ? dims.css.cell.height : (options.fontSize * 1.2);
                
                // Clone the entire xterm-rows content
                const clonedContent = xtermRows.cloneNode(true);
                
                // Copy computed colors from original spans to cloned spans FIRST
                // This is needed because xterm's CSS classes only work inside .xterm context
                const originalSpans = xtermRows.querySelectorAll('span');
                const clonedSpans = clonedContent.querySelectorAll('span');
                originalSpans.forEach((origSpan, i) => {
                    if (clonedSpans[i]) {
                        const computedStyle = window.getComputedStyle(origSpan);
                        clonedSpans[i].style.color = computedStyle.color;
                        if (computedStyle.fontWeight !== 'normal' && computedStyle.fontWeight !== '400') {
                            clonedSpans[i].style.fontWeight = computedStyle.fontWeight;
                        }
                        if (computedStyle.fontStyle !== 'normal') {
                            clonedSpans[i].style.fontStyle = computedStyle.fontStyle;
                        }
                        clonedSpans[i].style.userSelect = 'text';
                        clonedSpans[i].style.webkitUserSelect = 'text';
                        // Replace spaces with NBSP so whitespace is rendered and clickable
                        if (clonedSpans[i].textContent) {
                            clonedSpans[i].textContent = clonedSpans[i].textContent.replace(/ /g, '\u00A0');
                        }
                    }
                });
                
                // Fix row heights and pad AFTER copying colors (so span indices match)
                const cols = term.cols;
                const clonedRowDivs = clonedContent.querySelectorAll(':scope > div');
                clonedRowDivs.forEach(rowDiv => {
                    rowDiv.style.height = cellHeight + 'px';
                    rowDiv.style.lineHeight = cellHeight + 'px';
                    rowDiv.style.position = 'static';
                    rowDiv.style.top = 'auto';
                    
                    // Get current text length and pad to full width with NBSP
                    const currentText = rowDiv.textContent || '';
                    if (currentText.length < cols) {
                        const padding = '\u00A0'.repeat(cols - currentText.length);
                        const paddingSpan = document.createElement('span');
                        paddingSpan.textContent = padding;
                        paddingSpan.style.userSelect = 'text';
                        paddingSpan.style.webkitUserSelect = 'text';
                        rowDiv.appendChild(paddingSpan);
                    }
                });
                
                // Make the container selectable
                clonedContent.style.cssText = 'user-select: text; -webkit-user-select: text; pointer-events: auto; position: static; color: #33cc33;';
                
                // Replace content - use exact offset from xterm-rows position
                textContent.innerHTML = '';
                textContent.style.fontFamily = options.fontFamily || 'monospace';
                textContent.style.fontSize = options.fontSize + 'px';
                textContent.style.lineHeight = cellHeight + 'px';
                textContent.style.paddingLeft = offsetLeft + 'px';
                textContent.style.paddingTop = offsetTop + 'px';
                textContent.style.webkitFontSmoothing = 'antialiased';
                textContent.appendChild(clonedContent);
                
                textOverlay.classList.add('active');
                
                // Reset selection tracking
                hadSelection = false;
                
                // Haptic feedback
                if (navigator.vibrate) navigator.vibrate(100);
            }
            
            function hideTextOverlay() {
                if (textOverlay) {
                    textOverlay.classList.remove('active');
                }
            }
            
            // Close overlay when tapped
            textOverlay?.addEventListener('click', (e) => {
                // Don't close if user is selecting text
                const selection = window.getSelection();
                if (selection && selection.toString().length > 0) return;
                hideTextOverlay();
            });
            
            // Auto-close when selection is cleared (user likely copied)
            let hadSelection = false;
            document.addEventListener('selectionchange', () => {
                if (!textOverlay?.classList.contains('active')) return;
                
                const selection = window.getSelection();
                const hasSelection = selection && selection.toString().length > 0;
                
                // If we had a selection and now we don't, user probably copied
                if (hadSelection && !hasSelection) {
                    hideTextOverlay();
                    hadSelection = false;
                } else if (hasSelection) {
                    hadSelection = true;
                }
            });
            
            // Intercept copy to clean up non-breaking spaces
            textOverlay?.addEventListener('copy', (e) => {
                const selection = window.getSelection();
                if (selection) {
                    // Replace non-breaking spaces with regular spaces and trim each line
                    const cleanText = selection.toString()
                        .replace(/\u00A0/g, ' ')
                        .split('\n')
                        .map(line => line.trimEnd())
                        .join('\n');
                    e.clipboardData.setData('text/plain', cleanText);
                    e.preventDefault();
                }
            });
            
            // Wait for pyreplConsole to be ready
            const waitForTerminal = setInterval(() => {
                if (pyreplContainer.pyreplConsole?.term) {
                    clearInterval(waitForTerminal);
                    
                    const term = pyreplContainer.pyreplConsole.term;
                    const lineHeight = 18; // Approximate line height in pixels
                    
                    // Open expanded keyboard on mobile
                    if (window.innerWidth <= 600) {
                        openExpandedKeyboard();
                    }
                    
                    function stopMomentum() {
                        if (momentumFrame) {
                            cancelAnimationFrame(momentumFrame);
                            momentumFrame = null;
                        }
                        velocity = 0;
                    }
                    
                    function cancelLongPress() {
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                    }
                    
                    function applyMomentum() {
                        if (Math.abs(velocity) < 0.5) {
                            stopMomentum();
                            return;
                        }
                        
                        accumulatedDelta += velocity;
                        const linesToScroll = Math.trunc(accumulatedDelta / lineHeight);
                        
                        if (linesToScroll !== 0) {
                            term.scrollLines(linesToScroll);
                            accumulatedDelta -= linesToScroll * lineHeight;
                        }
                        
                        // Friction - slow down
                        velocity *= 0.95;
                        
                        momentumFrame = requestAnimationFrame(applyMomentum);
                    }
                    
                    replContainer.addEventListener('touchstart', (e) => {
                        // Don't handle if overlay is active
                        if (textOverlay?.classList.contains('active')) return;
                        
                        if (e.touches.length === 1) {
                            stopMomentum();
                            cancelLongPress();
                            touchStartY = e.touches[0].clientY;
                            touchStartX = e.touches[0].clientX;
                            lastTouchY = touchStartY;
                            lastTouchTime = Date.now();
                            touchStartTime = lastTouchTime;
                            isTouching = true;
                            isScrolling = false;
                            accumulatedDelta = 0;
                            
                            // Start long press timer
                            longPressTimer = setTimeout(() => {
                                if (isTouching && !isScrolling) {
                                    // Check if touch is on the input line (cursor line)
                                    // If so, don't show overlay - let user paste
                                    const dims = term.dimensions || term._core?._renderService?.dimensions;
                                    if (dims) {
                                        const xtermElement = document.querySelector('.pyrepl .xterm');
                                        const rect = xtermElement?.getBoundingClientRect();
                                        if (rect) {
                                            const xtermStyle = window.getComputedStyle(xtermElement);
                                            const paddingTop = parseFloat(xtermStyle.paddingTop) || 0;
                                            const relativeY = touchStartY - rect.top - paddingTop;
                                            const touchRow = Math.floor(relativeY / dims.css.cell.height);
                                            const cursorRow = term.buffer.active.cursorY;
                                            
                                            // If touching near the cursor line (±1 row), allow paste instead
                                            if (Math.abs(touchRow - cursorRow) <= 1) {
                                                isTouching = false;
                                                return;
                                            }
                                        }
                                    }
                                    
                                    showTextOverlay(term);
                                    isTouching = false;
                                }
                            }, LONG_PRESS_TIME);
                        }
                    }, { passive: true });
                    
                    replContainer.addEventListener('touchmove', (e) => {
                        if (!isTouching || e.touches.length !== 1) return;
                        
                        const now = Date.now();
                        const touchY = e.touches[0].clientY;
                        const touchX = e.touches[0].clientX;
                        
                        // If we haven't decided if this is scrolling yet
                        if (!isScrolling) {
                            const deltaFromStartY = Math.abs(touchY - touchStartY);
                            const deltaFromStartX = Math.abs(touchX - touchStartX);
                            
                            // If moved, cancel long press
                            if (deltaFromStartY > 5 || deltaFromStartX > 5) {
                                cancelLongPress();
                            }
                            
                            // If moved more horizontally, let it pass through
                            if (deltaFromStartX > SCROLL_THRESHOLD && deltaFromStartX > deltaFromStartY) {
                                isTouching = false;
                                return;
                            }
                            
                            // If moved enough vertically (more than horizontally), it's a scroll
                            if (deltaFromStartY > SCROLL_THRESHOLD) {
                                isScrolling = true;
                                cancelLongPress();
                            } else {
                                // Not yet determined, don't interfere
                                return;
                            }
                        }
                        
                        const deltaY = lastTouchY - touchY;
                        const deltaTime = now - lastTouchTime;
                        
                        // Calculate velocity (pixels per frame, assuming 16ms frames)
                        if (deltaTime > 0) {
                            velocity = (deltaY / deltaTime) * 16;
                        }
                        
                        lastTouchY = touchY;
                        lastTouchTime = now;
                        
                        // Immediate scroll
                        accumulatedDelta += deltaY;
                        const linesToScroll = Math.trunc(accumulatedDelta / lineHeight);
                        
                        if (linesToScroll !== 0) {
                            term.scrollLines(linesToScroll);
                            accumulatedDelta -= linesToScroll * lineHeight;
                        }
                    }, { passive: true });
                    
                    replContainer.addEventListener('touchend', () => {
                        cancelLongPress();
                        const wasScrolling = isScrolling;
                        isTouching = false;
                        isScrolling = false;
                        // Start momentum scrolling if we have velocity and were scrolling
                        if (wasScrolling && Math.abs(velocity) > 1) {
                            momentumFrame = requestAnimationFrame(applyMomentum);
                        }
                    }, { passive: true });
                    
                    replContainer.addEventListener('touchcancel', () => {
                        cancelLongPress();
                        isTouching = false;
                        isScrolling = false;
                        stopMomentum();
                    }, { passive: true });
                }
            }, 100);
        })();

        // Handle visual viewport resize (virtual keyboard on mobile)
        if (window.visualViewport) {
            function handleViewportResize() {
                const container = document.querySelector('.container');
                if (!container) return;
                // Set container height to visual viewport height
                const height = window.visualViewport.height;
                container.style.height = height + 'px';
                
                // Scroll to keep content visible
                window.scrollTo(0, window.visualViewport.offsetTop);
            }
            
            window.visualViewport.addEventListener('resize', handleViewportResize);
            window.visualViewport.addEventListener('scroll', handleViewportResize);
        }

        // Register service worker for PWA support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch((err) => {
                console.log('Service worker registration failed:', err);
            });
        }

        // Expanded keyboard functionality
        const expandedKeyboard = document.getElementById('expandedKeyboard');
        const numpadToggle = document.getElementById('numpadToggle');

        function openExpandedKeyboard() {
            expandedKeyboard.classList.add('active');
            document.body.classList.add('keyboard-open');
            // Measure keyboard height and set CSS variable for container padding
            requestAnimationFrame(() => {
                const height = expandedKeyboard.offsetHeight + 10;
                document.documentElement.style.setProperty('--expanded-keyboard-height', height + 'px');
            });
            // Blur terminal to prevent native keyboard from popping up
            const pyreplContainer = document.querySelector('.pyrepl');
            const termTextarea = pyreplContainer?.querySelector('.xterm-helper-textarea');
            if (termTextarea) {
                termTextarea.blur();
            }
        }

        function closeExpandedKeyboardFn() {
            expandedKeyboard.classList.remove('active');
            document.body.classList.remove('keyboard-open');
            document.documentElement.style.removeProperty('--expanded-keyboard-height');
        }

        function toggleExpandedKeyboard() {
            if (expandedKeyboard.classList.contains('active')) {
                closeExpandedKeyboardFn();
            } else {
                openExpandedKeyboard();
            }
        }

        numpadToggle.addEventListener('click', () => {
            if (navigator.vibrate) navigator.vibrate(20);
            toggleExpandedKeyboard();
        });
        numpadToggle.addEventListener('touchend', (e) => {
            e.preventDefault();
            toggleExpandedKeyboard();
        });

        // If terminal is focused while large keyboard is open, close the keyboard and allow focus
        document.addEventListener('focusin', (e) => {
            if (document.body.classList.contains('keyboard-open')) {
                const pyreplContainer = document.querySelector('.pyrepl');
                const termTextarea = pyreplContainer?.querySelector('.xterm-helper-textarea');
                if (e.target === termTextarea) {
                    closeExpandedKeyboardFn();
                }
            }
        });

        // Handle character input for expanded keyboard
        function attachExpandedKeyboardHandlers() {
            const pyreplContainer = document.querySelector('.pyrepl');
            
            const checkTerminal = setInterval(() => {
                if (pyreplContainer && pyreplContainer.pyreplConsole) {
                    clearInterval(checkTerminal);
                    
                    const termTextarea = pyreplContainer.querySelector('.xterm-helper-textarea');
                    
                    // Extended key sequences for expanded keyboard
                    const extKeySequences = {
                        ...keySequences,
                        'enter': '\r',
                        'backspace': '\x7f',
                        'ctrl-l': '\x0c'  // Ctrl+L (form feed / clear)
                    };
                    
                    // Key repeat state for backspace
                    let repeatInterval = null;
                    let repeatTimeout = null;
                    
                    function stopRepeat() {
                        if (repeatTimeout) {
                            clearTimeout(repeatTimeout);
                            repeatTimeout = null;
                        }
                        if (repeatInterval) {
                            clearInterval(repeatInterval);
                            repeatInterval = null;
                        }
                    }
                    
                    document.querySelectorAll('.expanded-keyboard-grid .key-btn').forEach(btn => {
                        btn.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            
                            // Start key repeat for backspace on mouse
                            if (btn.dataset.key === 'backspace') {
                                stopRepeat();
                                repeatTimeout = setTimeout(() => {
                                    repeatInterval = setInterval(() => {
                                        if (pyreplContainer.pyreplConsole) {
                                            pyreplContainer.pyreplConsole.push_char('\x7f'.charCodeAt(0));
                                        }
                                    }, 50);
                                }, 500);
                            }
                        });
                        
                        btn.addEventListener('mouseup', () => {
                            stopRepeat();
                        });
                        
                        btn.addEventListener('mouseleave', () => {
                            stopRepeat();
                        });
                        
                        btn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            // Haptic feedback immediately on touch
                            if (navigator.vibrate) navigator.vibrate(20);
                            
                            // Start key repeat for backspace
                            if (btn.dataset.key === 'backspace') {
                                stopRepeat();
                                // Initial delay before repeat starts (500ms)
                                repeatTimeout = setTimeout(() => {
                                    // Repeat every 50ms
                                    repeatInterval = setInterval(() => {
                                        if (pyreplContainer.pyreplConsole) {
                                            pyreplContainer.pyreplConsole.push_char('\x7f'.charCodeAt(0));
                                            if (navigator.vibrate) navigator.vibrate(10);
                                        }
                                    }, 50);
                                }, 500);
                            }
                        }, { passive: false });
                        
                        btn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            stopRepeat();
                            touchHandled = true;
                            sendInput();
                            setTimeout(() => { touchHandled = false; }, 400);
                        }, { passive: false });
                        
                        btn.addEventListener('touchcancel', () => {
                            stopRepeat();
                        });
                        
                        let touchHandled = false;
                        
                        const sendInput = () => {
                            // Skip function browser button (handled separately)
                            if (btn.id === 'functionBrowserBtn') return;
                            
                            const char = btn.dataset.char;
                            const key = btn.dataset.key;
                            
                            if (char && pyreplContainer.pyreplConsole) {
                                // Send character directly
                                for (const c of char) {
                                    pyreplContainer.pyreplConsole.push_char(c.charCodeAt(0));
                                }
                            } else if (key && extKeySequences[key] && pyreplContainer.pyreplConsole) {
                                // Send key sequence
                                for (const c of extKeySequences[key]) {
                                    pyreplContainer.pyreplConsole.push_char(c.charCodeAt(0));
                                }
                            }
                            
                            // Don't focus terminal - we want to keep native keyboard hidden
                        };
                        
                        btn.addEventListener('click', (e) => {
                            if (touchHandled) return;
                            e.preventDefault();
                            sendInput();
                        });
                    });
                    
                    // STO button: Check for pending input, show store modal
                    const stoBtn = document.getElementById('stoBtn');
                    let stoTouchHandled = false;
                    const handleSto = () => {
                        if (!pyreplContainer.pyreplConsole) return;
                        
                        // Check if there's pending input on the current line
                        const currentInput = getCurrentLineInput();
                        
                        if (currentInput) {
                            // There's input - show the store modal with the input value
                            openStoreModal(currentInput);
                        } else {
                            // No input - get the last result and show store modal
                            const lastResult = getLastResultValue();
                            if (lastResult) {
                                openStoreModal('_', lastResult, true);
                            }
                        }
                    };
                    stoBtn?.addEventListener('mousedown', (e) => { e.preventDefault(); });
                    stoBtn?.addEventListener('touchstart', (e) => { e.preventDefault(); if (navigator.vibrate) navigator.vibrate(20); }, { passive: false });
                    stoBtn?.addEventListener('touchend', (e) => { e.preventDefault(); stoTouchHandled = true; handleSto(); setTimeout(() => { stoTouchHandled = false; }, 400); }, { passive: false });
                    stoBtn?.addEventListener('click', (e) => { if (stoTouchHandled) return; e.preventDefault(); handleSto(); });
                    
                    // RCL button: opens history modal
                    const rclBtn = document.getElementById('rclBtn');
                    let rclTouchHandled = false;
                    
                    rclBtn?.addEventListener('mousedown', (e) => { e.preventDefault(); });
                    rclBtn?.addEventListener('touchstart', (e) => { e.preventDefault(); if (navigator.vibrate) navigator.vibrate(20); }, { passive: false });
                    rclBtn?.addEventListener('touchend', (e) => { e.preventDefault(); rclTouchHandled = true; openHistoryModal(); setTimeout(() => { rclTouchHandled = false; }, 400); }, { passive: false });
                    rclBtn?.addEventListener('click', (e) => { if (rclTouchHandled) return; e.preventDefault(); openHistoryModal(); });
                }
            }, 100);
        }

        attachExpandedKeyboardHandlers();

        // Store modal
        const storeModal = document.getElementById('storeModal');
        const storeModalTitle = document.getElementById('storeModalTitle');
        const storeGrid = document.getElementById('storeGrid');
        const storeModalClose = document.getElementById('storeModalClose');
        let pendingStoreValue = '';

        function getCurrentLineInput() {
            // Get the current input from the terminal's cursor line
            const pyreplContainer = document.querySelector('.pyrepl');
            if (!pyreplContainer?.pyreplConsole?.term) return '';
            
            const term = pyreplContainer.pyreplConsole.term;
            const buffer = term.buffer.active;
            // cursorY is relative to viewport, add baseY to get absolute line in buffer
            const absoluteY = buffer.baseY + buffer.cursorY;
            const line = buffer.getLine(absoluteY);
            if (!line) return '';
            
            let text = line.translateToString(true);
            // Check if this looks like an input line (contains >>> or ... prompt)
            // The prompt may have leading spaces or other formatting
            const promptMatch = text.match(/(>>>|\.\.\.)\s*/);
            if (!promptMatch) return '';  // Not an input line
            
            // Get everything after the prompt
            const promptEnd = promptMatch.index + promptMatch[0].length;
            text = text.substring(promptEnd);
            return text.trim();
        }

        function getLastResultValue() {
            // Get the value of the last result (_)
            if (!window.pyreplGet) return null;
            
            try {
                const result = window.pyreplGet('_');
                const data = JSON.parse(result);
                if (data.error || data.result === undefined) return null;
                const val = data.result;
                return typeof val === 'string' ? `'${val}'` : String(val);
            } catch (e) {
                return null;
            }
        }

        function truncateMiddle(str, maxLen) {
            if (str.length <= maxLen) return str;
            const ellipsis = '…';
            const charsToShow = maxLen - ellipsis.length;
            const frontChars = Math.ceil(charsToShow / 2);
            const backChars = Math.floor(charsToShow / 2);
            return str.substring(0, frontChars) + ellipsis + str.substring(str.length - backChars);
        }

        function openStoreModal(valueToStore, displayValue, isLastResult) {
            pendingStoreValue = valueToStore;
            const display = displayValue || valueToStore;
            const storeModalValue = document.getElementById('storeModalValue');
            if (isLastResult) {
                const truncated = truncateMiddle(display, 15);
                storeModalTitle.textContent = `Store last result (${truncated}) into:`;
                storeModalValue.style.display = 'none';
            } else {
                storeModalTitle.textContent = `Store ${display} into:`;
                storeModalValue.style.display = 'none';
            }
            renderStoreGrid();
            storeModal.classList.add('active');
        }

        function closeStoreModal() {
            storeModal.classList.remove('active');
            pendingStoreValue = '';
        }

        function renderStoreGrid() {
            const variables = ['ans', 'var1', 'var2', 'var3', 'var4', 'var5', 'var6', 'var7', 'var8'];
            let html = '';
            
            for (const varName of variables) {
                let currentValue = '(empty)';
                if (window.pyreplGet) {
                    try {
                        const result = window.pyreplGet(varName);
                        const data = JSON.parse(result);
                        if (!data.error && data.result !== undefined) {
                            const val = data.result;
                            currentValue = typeof val === 'string' ? `'${val}'` : String(val);
                            if (currentValue.length > 10) {
                                currentValue = currentValue.substring(0, 9) + '…';
                            }
                        }
                    } catch (e) {}
                }
                
                html += `
                    <button class="store-btn" data-var="${varName}">
                        <span class="store-btn-var">${varName}</span>
                        <span class="store-btn-value">${escapeHtml(currentValue)}</span>
                    </button>
                `;
            }
            
            storeGrid.innerHTML = html;
            
            // Add click handlers
            storeGrid.querySelectorAll('.store-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const varName = btn.dataset.var;
                    storeValueInto(varName);
                    closeStoreModal();
                });
            });
        }

        function storeValueInto(varName) {
            const pyreplContainer = document.querySelector('.pyrepl');
            if (!pyreplContainer?.pyreplConsole) return;
            
            // Capture the value before any async operations
            const valueToStore = pendingStoreValue;
            
            // Send ESC to clear current line
            pyreplContainer.pyreplConsole.push_char(0x1b);
            
            setTimeout(() => {
                // Send "a = <value>"
                const assignment = `${varName} = ${valueToStore}`;
                for (const c of assignment) {
                    pyreplContainer.pyreplConsole.push_char(c.charCodeAt(0));
                }
                // Send ENTER
                pyreplContainer.pyreplConsole.push_char('\r'.charCodeAt(0));
            }, 50);
        }

        storeModalClose?.addEventListener('click', closeStoreModal);
        storeModal?.addEventListener('click', (e) => {
            if (e.target === storeModal) closeStoreModal();
        });

        // History modal
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const historyModalClose = document.getElementById('historyModalClose');

        function openHistoryModal() {
            historyModal.classList.add('active');
            renderHistoryList();
        }

        function closeHistoryModal() {
            historyModal.classList.remove('active');
        }

        function getNumberedResults() {
            // Get history from Python's _history dict
            if (!window.pyreplGet) return [];
            
            try {
                // Get the _history dict: {1: "command1", 2: "command2", ...}
                const historyResult = window.pyreplGet('_history');
                const historyData = JSON.parse(historyResult);
                if (historyData.error || !historyData.result) {
                    return [];
                }
                
                const history = historyData.result;
                const results = [];
                
                // For each entry in history, get the corresponding value
                for (const key of Object.keys(history).sort((a, b) => parseInt(a) - parseInt(b))) {
                    const varName = `_${key}`;
                    const command = history[key];
                    
                    // Get the value of the variable
                    const valueResult = window.pyreplGet(varName);
                    const valueData = JSON.parse(valueResult);
                    if (valueData.error) continue;
                    
                    // Convert value to string representation
                    const value = typeof valueData.result === 'string' ? 
                        `'${valueData.result}'` : String(valueData.result);
                    
                    results.push([varName, command, value]);
                }
                
                return results;
            } catch (e) {
                console.log('Failed to get numbered results:', e);
                return [];
            }
        }

        function getSavedVariables() {
            // Get variables ans, var1-var8 that have been set by the user
            const variables = ['ans', 'var1', 'var2', 'var3', 'var4', 'var5', 'var6', 'var7', 'var8'];
            const saved = [];
            
            if (!window.pyreplGet) return saved;
            
            for (const varName of variables) {
                try {
                    const result = window.pyreplGet(varName);
                    const data = JSON.parse(result);
                    if (!data.error && data.result !== undefined) {
                        const val = data.result;
                        const value = typeof val === 'string' ? `'${val}'` : String(val);
                        saved.push([varName, value]);
                    }
                } catch (e) {}
            }
            
            return saved;
        }

        function renderHistoryList() {
            const numberedResults = getNumberedResults();
            const savedVars = getSavedVariables();
            const historySavedSection = document.getElementById('historySavedSection');
            
            let savedHtml = '';
            let historyHtml = '';
            
            // Saved section (ans and var1-var8) - rendered in non-scrolling area
            if (savedVars.length > 0) {
                savedHtml += '<div class="history-section">';
                savedHtml += '<div class="history-section-header">Saved</div>';
                savedHtml += '<div class="saved-vars-row">';
                
                // Show saved variables (ans, var1-var8)
                for (const [varName, value] of savedVars) {
                    const displayValue = value.length > 8 ? value.substring(0, 7) + '…' : value;
                    savedHtml += `<button class="saved-var-btn" data-var="${varName}"><span class="saved-var-name">${varName}</span><span class="saved-var-value">${escapeHtml(displayValue)}</span></button>`;
                }
                
                savedHtml += '</div></div>';
            }
            historySavedSection.innerHTML = savedHtml;
            
            if (numberedResults.length === 0 && savedVars.length === 0) {
                historyList.innerHTML = '<div class="function-loading">No history yet</div>';
                document.getElementById('historyAutomaticHeader').style.display = 'none';
                return;
            }

            // Automatic section (numbered results) - rendered in scrolling area
            const historyAutomaticHeader = document.getElementById('historyAutomaticHeader');
            if (numberedResults.length > 0) {
                historyAutomaticHeader.style.display = 'block';
                historyHtml += numberedResults.map(([varName, command, value]) => `
                    <div class="function-item history-item" data-var="${escapeHtml(varName)}">
                        <div class="history-line">
                            <span class="history-var">${escapeHtml(varName)}</span>
                            <span class="history-expression">${escapeHtml(truncateMiddle(command, 25))}</span>
                        </div>
                        <div class="history-result">= ${escapeHtml(truncateMiddle(value, 30))}</div>
                    </div>
                `).join('');
            } else {
                historyAutomaticHeader.style.display = 'none';
            }

            historyList.innerHTML = historyHtml;

            // Add click handlers for saved variable buttons
            historySavedSection.querySelectorAll('.saved-var-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const varName = btn.dataset.var;
                    if (varName) {
                        insertResult(varName);
                    }
                    closeHistoryModal();
                });
            });

            // Add click handlers for history items
            historyList.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const varName = item.dataset.var;
                    if (varName) {
                        insertResult(varName);
                    }
                    closeHistoryModal();
                });
            });

            // Scroll to the bottom to show most recent entries (only the automatic section scrolls)
            historyList.scrollTop = historyList.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function insertResult(varName) {
            const pyreplContainer = document.querySelector('.pyrepl');
            if (pyreplContainer?.pyreplConsole) {
                for (const c of varName) {
                    pyreplContainer.pyreplConsole.push_char(c.charCodeAt(0));
                }
            }
        }

        historyModalClose?.addEventListener('click', closeHistoryModal);
        historyModal?.addEventListener('click', (e) => {
            if (e.target === historyModal) closeHistoryModal();
        });

        // Function browser modal
        const functionModal = document.getElementById('functionModal');
        const functionBrowserBtn = document.getElementById('functionBrowserBtn');
        const functionModalClose = document.getElementById('functionModalClose');
        const functionSearchInput = document.getElementById('functionSearchInput');
        const functionList = document.getElementById('functionList');

        let allFunctions = [];
        let functionsLoaded = false;

        function openFunctionBrowser() {
            functionModal.classList.add('active');
            functionSearchInput.value = '';
            
            if (!functionsLoaded) {
                loadFunctions('*');
            } else {
                // Always show full list when reopening
                renderFunctionList(allFunctions);
            }
        }

        function closeFunctionBrowser() {
            functionModal.classList.remove('active');
            // Reset overlay size when closing
            functionModal.style.height = '';
            functionModal.style.top = '';
        }

        // Get the inner modal element
        const functionModalInner = functionModal.querySelector('.function-modal');

        // Handle visual viewport resize (keyboard appearing/disappearing)
        function updateModalForViewport() {
            if (window.visualViewport && functionModal.classList.contains('active')) {
                const vv = window.visualViewport;
                // Resize and reposition overlay to match visual viewport
                functionModal.style.height = vv.height + 'px';
                functionModal.style.top = vv.offsetTop + 'px';
                // Also constrain the inner modal
                functionModalInner.style.maxHeight = (vv.height - 40) + 'px';
            } else if (functionModalInner) {
                functionModalInner.style.maxHeight = '';
            }
        }

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', updateModalForViewport);
            window.visualViewport.addEventListener('scroll', updateModalForViewport);
        }

        function parseFunctionResult(jsonResult) {
            // Parse JSON result from pyreplCall - expects {result: [[name, desc, kind], ...]}
            try {
                const data = JSON.parse(jsonResult);
                if (data.error || !Array.isArray(data.result)) {
                    return null;
                }
                return data.result.map(item => ({ name: item[0], desc: item[1] || '', kind: item[2] || 'function' }));
            } catch (e) {
                return null;
            }
        }

        function loadFunctions(query) {
            const searchQuery = query === '*' ? '*' : (query || '*');
            const isFullLoad = searchQuery === '*';
            
            if (window.pyreplCall) {
                try {
                    const jsonResult = window.pyreplCall('_findGlobals', searchQuery);
                    const functions = parseFunctionResult(jsonResult);
                    if (functions) {
                        // Only update allFunctions when loading the full list
                        if (isFullLoad) {
                            allFunctions = functions;
                            functionsLoaded = true;
                        }
                        renderFunctionList(functions);
                    }
                } catch (e) {
                    console.log('pyreplCall failed:', e);
                }
            }
        }

        function renderFunctionList(functions) {
            if (functions.length === 0) {
                functionList.innerHTML = '<div class="function-loading">No functions found</div>';
                return;
            }
            
            functionList.innerHTML = functions.map(f => {
                // Escape name for use in data attribute
                const escapedName = f.name.replace(/"/g, '&quot;');
                const escapedDesc = (f.desc || '').replace(/"/g, '&quot;');
                return `
                <div class="function-item" data-name="${escapedName}" data-desc="${escapedDesc}" data-kind="${f.kind}">
                    <span class="function-item-name">${f.name}</span>
                    ${f.desc ? `<div class="function-item-desc">${f.desc}</div>` : ''}
                </div>
            `}).join('');
            
            // Attach click handlers
            functionList.querySelectorAll('.function-item').forEach(item => {
                item.addEventListener('click', () => {
                    const name = item.dataset.name;
                    const desc = item.dataset.desc || '';
                    const kind = item.dataset.kind || 'function';
                    insertFunctionText(name, desc, kind);
                    closeFunctionBrowser();
                });
            });
        }

        function insertFunctionText(text, desc, kind) {
            const pyreplContainer = document.querySelector('.pyrepl');
            if (!pyreplContainer || !pyreplContainer.pyreplConsole) return;
            
            let toInsert;
            if (kind === 'variable') {
                // Variable - no parens
                toInsert = text;
            } else if (kind === 'function_noargs') {
                // Function with no arguments - complete both parens
                toInsert = text + '()';
            } else {
                // Function with arguments - just open paren
                toInsert = text + '(';
            }
            
            for (const c of toInsert) {
                pyreplContainer.pyreplConsole.push_char(c.charCodeAt(0));
            }
            
            // Don't focus terminal - keep native keyboard hidden when using large keyboard
        }

        // Search functionality with debounce
        let searchTimeout;
        functionSearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            searchTimeout = setTimeout(async () => {
                if (query === '') {
                    // Show all functions
                    if (functionsLoaded) {
                        renderFunctionList(allFunctions);
                    } else {
                        loadFunctions('*');
                    }
                } else {
                    // Search with find()
                    await searchFunctions(query);
                }
            }, 300);
        });

        async function searchFunctions(query) {
            // Call find() with the search term through the terminal
            await loadFunctions(query);
        }

        // Event listeners for function browser
        functionBrowserBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openFunctionBrowser();
        });
        functionBrowserBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            openFunctionBrowser();
        });

        functionModalClose.addEventListener('click', closeFunctionBrowser);

        functionModal.addEventListener('click', (e) => {
            if (e.target === functionModal) {
                closeFunctionBrowser();
            }
        });
    </script>
</body>
</html>
